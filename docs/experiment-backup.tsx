/**
 * BACKUP / REFERENCE FILE
 * 
 * This file was generated by another AI as an experimental file.
 * It is kept here for reference purposes only and will NOT be used in the actual implementation.
 * 
 * NOTE: The names used in this file (e.g., "Anya Sharma", "Raj Patel") are examples only.
 * The actual implementation will use Bangladeshi corporate and government employee names.
 * 
 * File format: .tsx (TypeScript React) - contains JSX/React components
 * Location: docs/ (non-essential documentation folder)
 */

import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { BookOpen, CheckCircle, Clock, Plus, Folder, User, LogOut, Bell, Search, ArrowRight, ArrowLeft, X, Edit, RotateCcw, ArrowUp, ArrowDown, Mail, AlertTriangle, FileText, ChevronRight, Filter, Paperclip, File, Send, Zap } from 'lucide-react';

// --- UTILITIES & MOCK DATA ---
const useDebounce = (value, delay) => {
  const [debouncedValue, setDebouncedValue] = useState(value);
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);
  return debouncedValue;
};

// Mock User Context
const useAuth = () => {
  const [user, setUser] = useState({
    name: "Anya Sharma",
    role: "Approver", 
    id: 'user-001'
  });
  return { user, isAuthenticated: true };
};

// Helper for formatting timestamps (More formal/localized style)
const formatTimestamp = (isoDateString) => {
    const date = new Date(isoDateString);
    return date.toLocaleString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        timeZoneName: 'short'
    });
};

// Mock Data
const initialFiles = [
  { 
    id: 'RNPL-1001', 
    title: 'Q4 Budget Variance Report', 
    category: 'Finance', 
    status: 'Pending', 
    lastUpdated: '2025-11-30', 
    sender: 'Raj Patel', 
    isApproverAction: true, 
    summary: "Analysis of Q4 spending against projected budget with variance explanations. Requires immediate approval.",
    documentBody: "The Q4 financial performance indicates a 12% variance in operational expenditures, primarily driven by the unexpected server migration costs. We recommend reallocating the surplus from the marketing budget to cover this deficit. Attached are the detailed ledgers for your review.",
    history: [
        { timestamp: '2025-12-07T10:45:00Z', actor: 'Raj Patel', event: 'Sent for Approval', stateChange: 'Pending', note: 'Ready for Amit. Critical item due to year-end closing.' },
        { timestamp: '2025-12-06T09:00:00Z', actor: 'Raj Patel', event: 'Draft Created', stateChange: 'Draft', note: 'Initial creation of the file.' },
    ]
  },
  { 
    id: 'RNPL-1002', 
    title: 'New Employee Onboarding Policy', 
    category: 'HR', 
    status: 'Approved', 
    lastUpdated: '2025-12-01', 
    sender: 'Anya Sharma', 
    isApproverAction: false, 
    summary: "Updated guidelines for remote onboarding process. Final approval needed.",
    documentBody: "PURPOSE: To standardize the remote onboarding experience.\n\nSCOPE: All full-time employees joining after Jan 1st, 2026.\n\nPOLICY: All IT assets must be shipped 3 days prior to the start date. Access credentials will be provisioned via the IDM portal automatically upon contract signature.",
    history: [
        { timestamp: '2025-12-01T15:00:00Z', actor: 'Amit Singh (Approver)', event: 'Approved', stateChange: 'Approved', note: 'Policy looks solid. Go live next week.' },
        { timestamp: '2025-12-01T10:00:00Z', actor: 'Anya Sharma', event: 'Sent for Approval', stateChange: 'Pending', note: 'Please review the scope changes.' },
        { timestamp: '2025-11-28T09:00:00Z', actor: 'Anya Sharma', event: 'Draft Created', stateChange: 'Draft', note: 'Initial policy draft.' },
    ]
  },
  { 
    id: 'RNPL-1003', 
    title: 'Office Space Renovation Proposal', 
    category: 'Administration', 
    status: 'Returned', 
    lastUpdated: '2025-12-02', 
    sender: 'Siddharth Khan', 
    isApproverAction: true, 
    summary: "Cost estimates for 3rd floor renovation including new meeting rooms. Resubmission required.",
    documentBody: "Vendor: A-1 Construction\nEstimate: $45,000\nTimeline: 3 Weeks\n\nScope of Work includes demolition of existing cubicles, installation of glass partitions, and electrical rewiring for 4 new conference rooms.",
    history: [
        { timestamp: '2025-12-02T16:30:00Z', actor: 'Anya Sharma (Approver)', event: 'Returned', stateChange: 'Returned', note: 'Cost is too high. Find a cheaper vendor and resubmit.' },
        { timestamp: '2025-12-02T11:00:00Z', actor: 'Siddharth Khan', event: 'Sent for Approval', stateChange: 'Pending', note: 'Urgent renovation request.' },
        { timestamp: '2025-12-01T09:00:00Z', actor: 'Siddharth Khan', event: 'Draft Created', stateChange: 'Draft', note: 'Initial estimate.' },
    ]
  },
  { 
    id: 'RNPL-1004', 
    title: 'Server Upgrade Request', 
    category: 'IT', 
    status: 'Draft', 
    lastUpdated: '2025-12-03', 
    sender: 'Anya Sharma', 
    isApproverAction: false, 
    summary: "Request for 3 new blades for the primary cluster.",
    documentBody: "We are currently reaching 85% capacity on our primary compute cluster. To ensure stability during the upcoming peak season, we request the procurement of 3x Dell PowerEdge blades. \n\nTotal Cost: $12,000.",
    history: [
        { timestamp: '2025-12-03T10:00:00Z', actor: 'Anya Sharma', event: 'Draft Saved', stateChange: 'Draft', note: 'Initial draft, pending content review.' },
    ]
  },
  { 
    id: 'RNPL-1005', 
    title: 'Marketing Campaign Launch Plan', 
    category: 'Administration', 
    status: 'Pending', 
    lastUpdated: '2025-12-04', 
    sender: 'Jane Doe', 
    isApproverAction: true, 
    summary: "Q1 Social Media blitz strategy. Needs budget sign-off.",
    documentBody: "Strategy: Aggressive targeted ads on LinkedIn and Twitter focusing on our new Enterprise features.\nBudget: $5,000/month\nDuration: Jan - March 2026.",
    history: [
        { timestamp: '2025-12-04T12:00:00Z', actor: 'Jane Doe', event: 'Sent for Approval', stateChange: 'Pending', note: 'Submitted to Finance for budget review.' },
        { timestamp: '2025-12-04T09:00:00Z', actor: 'Jane Doe', event: 'Draft Created', stateChange: 'Draft', note: 'Campaign shell built.' },
    ]
  },
];

const mockCategories = ['HR', 'Finance', 'IT', 'Administration', 'Operations'];

// --- PREMIUM UI COMPONENTS ---

// 1. Status Indicator (The "Apple" Dot Style)
const StatusBadge = ({ status }) => {
  const styles = {
    'Approved': { color: 'text-emerald-700', bg: 'bg-emerald-50', dot: 'bg-emerald-500' },
    'Pending': { color: 'text-amber-700', bg: 'bg-amber-50', dot: 'bg-amber-500' },
    'Returned': { color: 'text-rose-700', bg: 'bg-rose-50', dot: 'bg-rose-500' },
    'Draft': { color: 'text-slate-600', bg: 'bg-slate-100', dot: 'bg-slate-400' },
    'In Review': { color: 'text-indigo-700', bg: 'bg-indigo-50', dot: 'bg-indigo-500' },
  };
  const style = styles[status] || styles['Draft'];

  return (
    <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${style.bg} ${style.color} border border-transparent`}>
      <span className={`w-1.5 h-1.5 rounded-full mr-2 ${style.dot}`} />
      {status}
    </span>
  );
};

// 2. Slide-Over Drawer (Context Preservation)
const SlideOver = ({ isOpen, onClose, children, title }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 overflow-hidden">
      <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity" onClick={onClose} />
      <div className="absolute inset-y-0 right-0 max-w-2xl w-full flex">
        <div className="w-full h-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col">
          {/* Header */}
          <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-10">
            <h2 className="text-lg font-semibold text-slate-800">{title}</h2>
            <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors">
              <X size={20} />
            </button>
          </div>
          {/* Content */}
          <div className="flex-1 overflow-y-auto bg-slate-50/50">
            {children}
          </div>
        </div>
      </div>
    </div>
  );
};

// 3. Modal (Refined)
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-[60]">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
        <div className="flex justify-between items-center p-5 border-b border-slate-100">
          <h3 className="text-lg font-semibold text-slate-800">{title}</h3>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
            <X size={20} />
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

// --- LOGIC HELPERS ---
const getMockNotifications = (user, files) => {
  const notifications = [];
  files.forEach(file => {
    if (user.role === 'Approver' && file.isApproverAction && (file.status === 'Pending' || file.status === 'Returned')) {
      const isPending = file.status === 'Pending';
      notifications.push({
        id: `notif-appr-${file.id}`,
        type: isPending ? 'Action' : 'Urgent',
        message: isPending ? `Approval Request: ${file.title}` : `Resubmitted: ${file.title}`,
        subtext: `From: ${file.sender}`,
        icon: isPending ? <Clock size={16} className="text-amber-500" /> : <AlertTriangle size={16} className="text-rose-500" />,
        fileId: file.id,
        timestamp: file.lastUpdated,
      });
    }
    if (file.sender === user.name && (file.status === 'Approved' || file.status === 'Returned')) {
      const isApproved = file.status === 'Approved';
      notifications.push({
        id: `notif-user-${file.id}`,
        type: isApproved ? 'Success' : 'Attention',
        message: isApproved ? `Approved: ${file.title}` : `Returned: ${file.title}`,
        subtext: isApproved ? 'Ready for processing' : 'Review comments required',
        icon: isApproved ? <CheckCircle size={16} className="text-emerald-500" /> : <X size={16} className="text-rose-500" />,
        fileId: file.id,
        timestamp: file.lastUpdated,
      });
    }
  });
  return notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
};

// --- CORE COMPONENTS ---

// Notification Popover (Refined)
const NotificationPopover = ({ notifications, onAction, onClose }) => {
  const popoverRef = useRef(null);
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (popoverRef.current && !popoverRef.current.contains(event.target)) onClose();
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [onClose]);

  return (
    <div ref={popoverRef} className="absolute right-0 mt-4 w-80 max-h-[60vh] overflow-y-auto rounded-2xl shadow-xl bg-white ring-1 ring-black/5 z-50 origin-top-right animate-in fade-in zoom-in-95 duration-200">
      <div className="px-5 py-4 border-b border-slate-50 bg-slate-50/50">
        <h3 className="text-sm font-bold text-slate-800 uppercase tracking-wider">Notifications</h3>
      </div>
      <div className="divide-y divide-slate-50">
        {notifications.length > 0 ? (
          notifications.map((notif) => (
            <div key={notif.id} onClick={() => onAction(notif)} className="p-4 hover:bg-slate-50 cursor-pointer transition-colors group">
              <div className="flex gap-3">
                <div className="mt-1 bg-white p-1.5 rounded-full shadow-sm ring-1 ring-slate-100">{notif.icon}</div>
                <div>
                  <p className="text-sm font-medium text-slate-800 group-hover:text-indigo-600 transition-colors">{notif.message}</p>
                  <p className="text-xs text-slate-500 mt-0.5">{notif.subtext}</p>
                  <p className="text-[10px] text-slate-400 mt-2 font-medium">{formatTimestamp(notif.timestamp)}</p>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div className="p-8 text-center text-slate-400 text-sm">No new updates</div>
        )}
      </div>
    </div>
  );
};

// Navigation (Glassmorphism & Clean)
const TopNavBar = ({ user, activeModule, setActiveModule, notifications, onNotificationAction }) => {
  const [isNotificationOpen, setIsNotificationOpen] = useState(false);
  
  return (
    <header className="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200/60">
      <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveModule('Dashboard')}>
          <div className="bg-indigo-600 p-1.5 rounded-lg text-white">
            <BookOpen size={20} />
          </div>
          <span className="text-lg font-bold text-slate-900 tracking-tight">RNPL Note</span>
        </div>

        <nav className="hidden md:flex items-center gap-1 bg-slate-100/50 p-1 rounded-xl border border-slate-200/50">
          {['Dashboard', 'My Nothis', user.role === 'Approver' ? 'Pending Approvals' : null].filter(Boolean).map(module => (
            <button
              key={module}
              onClick={() => { setActiveModule(module); setIsNotificationOpen(false); }}
              className={`px-4 py-1.5 text-sm font-medium rounded-lg transition-all duration-200 ${
                activeModule === module
                  ? 'bg-white text-indigo-700 shadow-sm ring-1 ring-black/5'
                  : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'
              }`}
            >
              {module}
            </button>
          ))}
        </nav>

        <div className="flex items-center gap-4">
          <button 
            onClick={() => setActiveModule('Create Nothi')} // Terminology Change
            className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-900 text-white text-sm font-medium rounded-lg hover:bg-slate-800 active:scale-95 transition-all shadow-sm"
          >
            <Plus size={16} /> New Nothi
          </button>

          <div className="h-6 w-px bg-slate-200 mx-1"></div>

          <div className="relative">
            <button
              onClick={() => setIsNotificationOpen(!isNotificationOpen)}
              className="text-slate-500 hover:text-indigo-600 p-2 rounded-full hover:bg-indigo-50 transition-all relative"
            >
              <Bell size={20} />
              {notifications.length > 0 && (
                <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-rose-500 rounded-full ring-2 ring-white"></span>
              )}
            </button>
            {isNotificationOpen && <NotificationPopover notifications={notifications} onAction={(n) => { onNotificationAction(n); setIsNotificationOpen(false); }} onClose={() => setIsNotificationOpen(false)} />}
          </div>

          <div className="flex items-center gap-3 pl-2">
            <div className="text-right hidden sm:block">
              <p className="text-sm font-semibold text-slate-800 leading-tight">{user.name}</p>
              <p className="text-xs text-slate-500 leading-tight">{user.role}</p>
            </div>
            <div className="h-9 w-9 rounded-full bg-indigo-100 border border-indigo-200 flex items-center justify-center text-indigo-700 font-bold text-sm">
              {user.name.charAt(0)}
            </div>
          </div>
        </div>
      </div>
    </header>
  );
};

// --- DASHBOARD & LIST COMPONENTS ---

const StatCard = ({ title, value, icon: Icon, onClick, colorClass }) => (
  <div onClick={onClick} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md hover:border-indigo-100 transition-all cursor-pointer group">
    <div className="flex items-start justify-between mb-4">
      <div className={`p-3 rounded-xl ${colorClass} bg-opacity-10 group-hover:scale-110 transition-transform duration-300`}>
        <Icon className={colorClass.replace('bg-', 'text-')} size={24} />
      </div>
      {value && <span className="text-3xl font-bold text-slate-800">{value}</span>}
    </div>
    <h3 className="text-sm font-medium text-slate-500 group-hover:text-indigo-600 transition-colors">{title}</h3>
  </div>
);

const NothiListItem = ({ nothi, onClick }) => ( // Component renamed to NothiListItem
  <div onClick={() => onClick(nothi)} className="group flex items-center justify-between p-4 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-100 cursor-pointer transition-all duration-200">
    <div className="flex items-center gap-4 overflow-hidden">
      <div className="bg-slate-50 p-2.5 rounded-lg text-slate-400 group-hover:text-indigo-600 group-hover:bg-indigo-50 transition-colors">
        <FileText size={20} />
      </div>
      <div className="min-w-0">
        <h4 className="text-sm font-semibold text-slate-900 truncate group-hover:text-indigo-700 transition-colors">{nothi.title}</h4>
        <p className="text-xs text-slate-500 truncate flex items-center gap-2">
          <span>{nothi.id}</span>
          <span className="w-1 h-1 rounded-full bg-slate-300"></span>
          <span>{nothi.sender}</span>
        </p>
      </div>
    </div>
    <div className="flex items-center gap-4 pl-4 shrink-0">
      <StatusBadge status={nothi.status} />
      <ChevronRight size={16} className="text-slate-300 group-hover:text-indigo-400 group-hover:translate-x-1 transition-all" />
    </div>
  </div>
);

const Dashboard = ({ user, files, onOpenFile, setActiveModule }) => {
  const isApprover = user.role === 'Approver';
  const pendingCount = files.filter(f => f.isApproverAction && (f.status === 'Pending' || f.status === 'Returned')).length;
  
  const relevantFiles = isApprover 
    ? files.filter(f => f.isApproverAction && (f.status === 'Pending' || f.status === 'Returned')).slice(0, 3)
    : files.filter(f => f.sender === user.name).slice(0, 3);

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Workspace</h1>
          <p className="text-slate-500 mt-1">Good morning, {user.name}. Here's what's happening today.</p>
        </div>
        <span className="text-sm font-medium text-slate-400 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
          {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
        </span>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatCard title="Create New Nothi" icon={Plus} colorClass="bg-indigo-600 text-indigo-600" onClick={() => setActiveModule('Create Nothi')} /> {/* Terminology Change */}
        <StatCard title="My Nothis" value={files.filter(f => f.sender === user.name).length} icon={Folder} colorClass="bg-blue-500 text-blue-500" onClick={() => setActiveModule('My Nothis')} /> {/* Terminology Change */}
        {isApprover && (
          <StatCard title="Pending Approvals" value={pendingCount} icon={CheckCircle} colorClass="bg-amber-500 text-amber-500" onClick={() => setActiveModule('Pending Approvals')} />
        )}
      </div>

      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-slate-800">
            {isApprover ? 'Nothis Requiring Attention' : 'Recent Nothi Activity'} {/* Terminology Change */}
          </h2>
          <button onClick={() => setActiveModule(isApprover ? 'Pending Approvals' : 'My Nothis')} className="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
            View All <ArrowRight size={14} />
          </button>
        </div>
        
        <div className="grid gap-3">
          {relevantFiles.length > 0 ? (
            relevantFiles.map(file => <NothiListItem key={file.id} nothi={file} onClick={onOpenFile} />) // Component Renamed
          ) : (
             <div className="p-10 border border-dashed border-slate-200 rounded-xl flex flex-col items-center justify-center text-center bg-slate-50/50">
                <div className="bg-white p-3 rounded-full shadow-sm mb-3">
                    <Folder className="text-slate-300" size={24} />
                </div>
                <p className="text-slate-500 text-sm font-medium">No nothis currently require your attention.</p> {/* Terminology Change */}
             </div>
          )}
        </div>
      </div>
    </div>
  );
};

const FileListTable = ({ user, files, title, filterFn, onOpenFile }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('All');
  
  const filteredFiles = useMemo(() => {
    return files.filter(filterFn).filter(f => {
      const matchesSearch = f.title.toLowerCase().includes(searchTerm.toLowerCase()) || f.id.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesStatus = statusFilter === 'All' || f.status === statusFilter;
      return matchesSearch && matchesStatus;
    });
  }, [files, filterFn, searchTerm, statusFilter]);

  return (
    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden animate-in fade-in duration-300">
      <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <h2 className="text-lg font-bold text-slate-800">{title}</h2>
        <div className="flex gap-3">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <input 
              type="text" 
              placeholder="Search Nothis..." // Terminology Change
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              className="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 w-full md:w-64 transition-all"
            />
          </div>
          <select 
            value={statusFilter}
            onChange={e => setStatusFilter(e.target.value)}
            className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 text-slate-600 cursor-pointer"
          >
            <option value="All">All Status</option>
            {['Draft', 'Pending', 'In Review', 'Approved', 'Returned'].map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      </div>
      
      <div className="overflow-x-auto">
        <table className="w-full text-left">
          <thead className="bg-slate-50 border-b border-slate-100">
            <tr>
              {['Nothi', 'Status', 'Category', 'Last Updated', ''].map((h, i) => ( // Terminology Change
                <th key={i} className="px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">{h}</th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-50">
            {filteredFiles.map(file => (
              <tr key={file.id} onClick={() => onOpenFile(file)} className="hover:bg-slate-50/80 cursor-pointer transition-colors group">
                <td className="px-6 py-4">
                  <div className="font-medium text-slate-900 group-hover:text-indigo-700 transition-colors">{file.title}</div>
                  <div className="text-xs text-slate-400 mt-1 font-mono">{file.id}</div>
                </td>
                <td className="px-6 py-4"><StatusBadge status={file.status} /></td>
                <td className="px-6 py-4 text-sm text-slate-600">{file.category}</td>
                <td className="px-6 py-4 text-sm text-slate-500 font-mono">{file.lastUpdated}</td>
                <td className="px-6 py-4 text-right">
                  <ChevronRight size={18} className="text-slate-300 group-hover:text-indigo-500 ml-auto" />
                </td>
              </tr>
            ))}
            {filteredFiles.length === 0 && (
              <tr><td colSpan={5} className="px-6 py-12 text-center text-slate-400 italic">No nothis found matching your criteria.</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- ACTION MODULES ---

const CreateFile = ({ user, onCreateSuccess }) => {
  const [formData, setFormData] = useState({ title: '', summary: '', category: '', tags: '', documentBody: '' });
  
  const handleSave = (isDraft) => {
    if (!formData.title || !formData.category) return; // Simple validation
    
    const newHistory = [
        { 
            timestamp: new Date().toISOString(), 
            actor: user.name, 
            event: isDraft ? 'Draft Saved' : 'Sent for Approval', 
            stateChange: isDraft ? 'Draft' : 'Pending', 
            note: isDraft ? 'Nothi created and saved as draft.' : 'Initiated new approval request.'
        }
    ];

    const newFile = {
      ...formData,
      id: `RNPL-${Math.floor(Math.random() * 8999) + 1000}`,
      sender: user.name,
      status: isDraft ? 'Draft' : 'Pending',
      lastUpdated: new Date().toISOString().slice(0, 10),
      isApproverAction: !isDraft,
      documentBody: formData.documentBody || "No content provided.",
      history: newHistory, // Attach history
    };
    onCreateSuccess(newFile, isDraft);
  };

  return (
    <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-in slide-in-from-bottom-4 duration-500">
      <div className="px-8 py-6 border-b border-slate-100 bg-slate-50/30">
        <h2 className="text-xl font-bold text-slate-900">Create New Nothi</h2> {/* Terminology Change */}
        <p className="text-slate-500 text-sm mt-1">Start a new workflow or save a draft for later.</p>
      </div>
      <div className="p-8 space-y-6">
        <div>
          <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Nothi Title <span className="text-rose-500">*</span></label> {/* Terminology Change */}
          <input 
            type="text" 
            className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none" 
            placeholder="e.g. Q3 Marketing Budget"
            value={formData.title}
            onChange={e => setFormData({...formData, title: e.target.value})}
          />
        </div>
        <div className="grid grid-cols-2 gap-6">
          <div>
            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Category <span className="text-rose-500">*</span></label>
            <select 
              className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none appearance-none"
              value={formData.category}
              onChange={e => setFormData({...formData, category: e.target.value})}
            >
              <option value="">Select...</option>
              {mockCategories.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Tags</label>
            <input 
              type="text" 
              className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none" 
              placeholder="comma, separated"
              value={formData.tags}
              onChange={e => setFormData({...formData, tags: e.target.value})}
            />
          </div>
        </div>
        <div>
          <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Executive Summary</label>
          <textarea 
            rows={2}
            className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none resize-none" 
            placeholder="Brief description for the cover sheet..."
            value={formData.summary}
            onChange={e => setFormData({...formData, summary: e.target.value})}
          />
        </div>
        <div>
          <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Document Body (The "Attachment")</label>
          <textarea 
            rows={6}
            className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all outline-none resize-none font-serif" 
            placeholder="Draft the main content of the letter or report here..."
            value={formData.documentBody}
            onChange={e => setFormData({...formData, documentBody: e.target.value})}
          />
        </div>
        <div className="pt-6 flex items-center justify-end gap-3 border-t border-slate-100">
            <button onClick={() => handleSave(true)} className="px-5 py-2.5 text-slate-600 font-medium hover:bg-slate-50 rounded-lg transition-colors">Save Draft</button>
            <button onClick={() => handleSave(false)} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-sm hover:shadow-md active:scale-95 transition-all">Create & Submit</button>
        </div>
      </div>
    </div>
  );
};

// --- HISTORY COMPONENT ---

const DocumentHistory = ({ history }) => {
    // History is already ordered chronologically (oldest first) in mock data, 
    // so we reverse it for display (newest first).
    const reversedHistory = useMemo(() => [...history].reverse(), [history]);
    const totalSteps = reversedHistory.length;

    const getIconForEvent = (event) => {
        switch(event) {
            case 'Approved': return <CheckCircle size={16} className="text-emerald-600" />;
            case 'Returned': return <RotateCcw size={16} className="text-rose-600" />;
            case 'Sent for Approval': 
            case 'Resubmitted for Approval': 
            case 'Forwarded': return <Send size={16} className="text-amber-600" />;
            case 'Draft Created':
            case 'Draft Saved': return <File size={16} className="text-slate-500" />;
            default: return <Clock size={16} className="text-indigo-600" />;
        }
    };

    return (
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
            <h3 className="text-sm font-bold text-slate-800 uppercase tracking-wider mb-4">Nothi Journey ({totalSteps} Steps)</h3> {/* Terminology Change */}
            <div className="relative pl-4 space-y-6 before:absolute before:left-0 before:top-2 before:bottom-0 before:w-0.5 before:bg-slate-200">
                {reversedHistory.map((step, index) => {
                    const isCurrent = index === 0;
                    const eventIcon = getIconForEvent(step.event);

                    return (
                        <div key={index} className="relative pl-6 pb-2 group">
                            {/* Timeline Dot */}
                            <div className={`absolute left-[-6px] top-1 w-3 h-3 rounded-full flex items-center justify-center 
                                ${isCurrent ? 'bg-indigo-600 ring-4 ring-indigo-50/50' : 'bg-slate-300 ring-4 ring-white'}`}>
                                <div className="p-0.5 bg-white rounded-full">
                                    {eventIcon}
                                </div>
                            </div>
                            
                            <p className="text-xs text-slate-400 mb-0.5 font-mono">{formatTimestamp(step.timestamp)}</p>
                            <p className={`text-sm font-semibold ${isCurrent ? 'text-indigo-700' : 'text-slate-800'}`}>
                                {step.event}
                                <span className="text-xs font-normal text-slate-500 ml-2">by {step.actor}</span>
                            </p>
                            <p className="text-xs text-slate-500 mt-1">Status: <span className="font-medium text-slate-700">{step.stateChange}</span></p>

                            {step.note && (
                                <p className="text-xs mt-2 p-2 bg-slate-50 border border-slate-100 rounded-lg text-slate-600 italic max-w-sm">
                                    <span className="font-semibold text-slate-800 mr-1">Note:</span> {step.note}
                                </p>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

// --- FILE INSPECTOR (THE DRAWER) ---

const FileInspector = ({ file, user, onClose, onUpdate }) => {
  const [activeTab, setActiveTab] = useState('notes'); // 'notes' | 'document'
  const [action, setAction] = useState(null); 
  
  const isApprover = user.role === 'Approver';
  const canAct = isApprover && file.isApproverAction && (file.status === 'Pending' || file.status === 'Returned');
  
  const handleActionSubmit = (note) => {
    let updates = { lastUpdated: new Date().toISOString().slice(0, 10) };
    const newTimestamp = new Date().toISOString();
    const actor = user.name + (isApprover ? ' (Approver)' : '');

    let newHistoryEntry = {
        timestamp: newTimestamp,
        actor: actor,
        note: note || `Action taken by ${user.name}.`
    };

    if (action === 'approve') {
        updates = { status: 'Approved', approvalComment: note, isApproverAction: false };
        newHistoryEntry = { ...newHistoryEntry, event: 'Approved', stateChange: 'Approved' };
    } else if (action === 'return') {
        updates = { status: 'Returned', returnComment: note, isApproverAction: true };
        newHistoryEntry = { ...newHistoryEntry, event: 'Returned', stateChange: 'Returned' };
    } else if (action === 'forward') {
        updates = { status: 'Pending', forwardingNote: note, isApproverAction: true };
        newHistoryEntry = { ...newHistoryEntry, event: 'Forwarded', stateChange: 'Pending' };
    }
    
    // Crucial: Prepend new entry to the existing history
    updates.history = [newHistoryEntry, ...file.history];
    
    onUpdate(file.id, updates);
    setAction(null);
    onClose();
  };

  const ActionButton = ({ label, icon: Icon, color, onClick }) => (
    <button onClick={onClick} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border ${color} font-medium transition-all shadow-sm active:scale-95`}>
      <Icon size={18} /> {label}
    </button>
  );

  const getNextActionGuidance = (status) => {
    if (file.sender === user.name) {
        if (status === 'Draft') return { type: 'Info', text: 'Edit your content and submit it for approval when ready.' };
        if (status === 'Returned') return { type: 'Warning', text: 'Review the Approverâ€™s comments and resubmit the Nothi.' };
        if (status === 'Pending') return { type: 'Info', text: 'Waiting for the Approver to take action.' };
        if (status === 'Approved') return { type: 'Success', text: 'The Nothi is complete. Proceed with the documented task.' };
    } else if (isApprover) {
        if (status === 'Pending') return { type: 'Action', text: 'You need to Approve, Return, or Forward this Nothi.' };
        if (status === 'Returned') return { type: 'Action', text: 'The sender has resubmitted. Review and decide on approval.' };
    }
    return { type: 'Info', text: 'The Nothi is currently following its established workflow path.' };
  };

  const guidance = getNextActionGuidance(file.status);
  const guidanceStyles = {
    Info: 'bg-indigo-50 text-indigo-700 border-indigo-200',
    Warning: 'bg-rose-50 text-rose-700 border-rose-200',
    Success: 'bg-emerald-50 text-emerald-700 border-emerald-200',
    Action: 'bg-amber-50 text-amber-700 border-amber-200',
  };

  return (
    <>
      <div className="flex flex-col h-full">
        {/* Tab Switcher - The "Real Life" Flip */}
        <div className="flex bg-slate-100 p-1 rounded-xl mb-6 sticky top-0 z-10 mx-6 mt-6">
            <button 
                onClick={() => setActiveTab('notes')}
                className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'notes' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
            >
                Note Sheet
            </button>
            <button 
                onClick={() => setActiveTab('document')}
                className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'document' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
            >
                Attached Document
            </button>
        </div>

        <div className="px-6 pb-6 space-y-8 flex-1">
            {/* VIEW 1: NOTE SHEET (Metadata & History) */}
            {activeTab === 'notes' && (
                <div className="animate-in fade-in duration-300 space-y-8">
                    {/* Status Header & Next Action Guidance */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-xl font-bold text-slate-900 leading-tight">{file.title}</h1>
                                <p className="text-slate-400 text-xs mt-2 font-mono">{file.id}</p>
                            </div>
                            <StatusBadge status={file.status} />
                        </div>
                    
                        {/* Next Action Guidance (New Feature) */}
                        <div className={`mt-4 p-4 rounded-xl border ${guidanceStyles[guidance.type]} flex items-start gap-3`}>
                            <Zap size={20} className="mt-0.5 shrink-0" />
                            <div>
                                <p className="text-sm font-semibold leading-tight">Next Expected Action:</p>
                                <p className="text-sm mt-1 leading-relaxed">{guidance.text}</p>
                            </div>
                        </div>

                        {/* Primary Actions Area */}
                        {canAct && (
                            <div className="mt-6 pt-6 border-t border-slate-100 flex gap-3">
                                <ActionButton label="Approve" icon={CheckCircle} color="bg-emerald-600 hover:bg-emerald-700 text-white border-transparent" onClick={() => setAction('approve')} />
                                <ActionButton label="Return" icon={RotateCcw} color="bg-white hover:bg-rose-50 text-rose-600 border-rose-200" onClick={() => setAction('return')} />
                                <ActionButton label="Forward" icon={ArrowRight} color="bg-white hover:bg-indigo-50 text-indigo-600 border-indigo-200" onClick={() => setAction('forward')} />
                            </div>
                        )}
                        {/* Resubmit Action */}
                        {file.sender === user.name && file.status === 'Returned' && (
                            <div className="mt-6 pt-6 border-t border-slate-100">
                                <button 
                                    onClick={() => { 
                                        const newHistoryEntry = { 
                                            timestamp: new Date().toISOString(), 
                                            actor: user.name, 
                                            event: 'Resubmitted for Approval', 
                                            stateChange: 'Pending', 
                                            note: 'Nothi has been corrected and resubmitted.' 
                                        };
                                        onUpdate(file.id, { 
                                            status: 'Pending', 
                                            isApproverAction: true, 
                                            history: [newHistoryEntry, ...file.history] 
                                        }); 
                                        onClose(); 
                                    }} 
                                    className="w-full py-3 bg-indigo-600 text-white rounded-xl font-medium shadow-sm hover:bg-indigo-700 active:scale-95 transition-all"
                                >
                                    Resubmit Nothi for Approval
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Details Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                            <p className="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-1">Category</p>
                            <p className="font-medium text-slate-800">{file.category}</p>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                            <p className="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-1">Sender</p>
                            <p className="font-medium text-slate-800 flex items-center gap-2">
                                <span className="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">{file.sender[0]}</span>
                                {file.sender}
                            </p>
                        </div>
                        <div className="col-span-1 md:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60">
                            <p className="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-2">Executive Summary</p>
                            <p className="text-slate-600 leading-relaxed text-sm">{file.summary || "No summary provided."}</p>
                        </div>
                    </div>

                    {/* History Stream Component */}
                    {file.history && <DocumentHistory history={file.history} />}
                    
                </div>
            )}

            {/* VIEW 2: DOCUMENT PREVIEW (The "Attachment") */}
            {activeTab === 'document' && (
                <div className="animate-in fade-in duration-300 flex flex-col items-center">
                    {/* The "Paper" Container - Enhanced with a subtle grain texture/shadow */}
                    <div className="bg-white w-full aspect-[1/1.414] shadow-lg border border-slate-200 p-8 md:p-12 relative mx-auto max-w-lg document-paper-texture">
                        {/* Watermark / Letterhead */}
                        <div className="absolute top-8 left-8 right-8 border-b-2 border-slate-900 pb-4 flex justify-between items-end">
                            <div>
                                <h2 className="text-2xl font-serif font-bold text-slate-900">RNPL Corp.</h2>
                                <p className="text-xs font-serif text-slate-500 uppercase tracking-widest mt-1">Official Memorandum</p>
                            </div>
                            <div className="text-right">
                                <p className="text-xs font-serif text-slate-500">Ref: {file.id}</p>
                                <p className="text-xs font-serif text-slate-500">Date: {file.lastUpdated}</p>
                            </div>
                        </div>

                        {/* Document Body */}
                        <div className="mt-24 font-serif text-slate-800 leading-relaxed text-sm whitespace-pre-wrap">
                            <p className="mb-4"><strong>Subject:</strong> {file.title}</p>
                            {file.documentBody || "No document content available."}
                        </div>

                        {/* Signature Area */}
                        <div className="absolute bottom-12 right-12 text-center">
                            {/* A mock digital signature placeholder */}
                            <div className="font-cursive text-xl text-slate-900 mb-1 leading-none">{file.sender}</div>
                            <div className="border-t border-slate-400 w-32 pt-1">
                                <p className="text-[10px] uppercase tracking-wider text-slate-500">Digital Signature</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Floating Action Button for Approver Context */}
                    {canAct && (
                        <div className="sticky bottom-6 mt-6 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-4 animate-in slide-in-from-bottom-2">
                             <span className="text-sm font-medium">Ready to decide on this Nothi?</span>
                             <button onClick={() => setActiveTab('notes')} className="text-sm font-bold text-indigo-300 hover:text-white underline decoration-indigo-300/50 underline-offset-4">Go to Actions</button>
                        </div>
                    )}
                </div>
            )}
        </div>
      </div>

      {/* Action Modal */}
      <Modal isOpen={!!action} onClose={() => setAction(null)} title={`${action ? action.charAt(0).toUpperCase() + action.slice(1) : ''} Nothi`}> {/* Terminology Change */}
         <div className="space-y-4">
            <p className="text-slate-600 text-sm">Please provide a comment or note for this action.</p>
            <textarea 
               id="action-note"
               className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none text-sm" 
               rows={4} 
               placeholder="Type your official comments here..." 
            />
            <div className="flex justify-end gap-3 pt-2">
               <button onClick={() => setAction(null)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors text-sm font-medium">Cancel</button>
               <button 
                  onClick={() => handleActionSubmit(document.getElementById('action-note').value)} 
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-sm active:scale-95 transition-all text-sm font-medium"
               >
                  Confirm
               </button>
            </div>
         </div>
      </Modal>
    </>
  );
};


// --- APP ORCHESTRATOR ---

const App = () => {
  const { user } = useAuth();
  const [activeModule, setActiveModule] = useState('Dashboard');
  const [files, setFiles] = useState(initialFiles);
  const [viewingFile, setViewingFile] = useState(null); // File currently in drawer

  const notifications = useMemo(() => getMockNotifications(user, files), [user, files]);

  // Actions
  const handleOpenFile = (file) => setViewingFile(file);
  
  const handleCreateSuccess = (newFile, isDraft) => {
    setFiles([newFile, ...files]);
    setActiveModule(isDraft ? 'My Nothis' : 'Dashboard'); // Terminology Change
    if (!isDraft) setViewingFile(newFile);
  };

  const handleUpdateFile = useCallback((id, updates) => {
    setFiles(prev => prev.map(f => f.id === id ? { ...f, ...updates } : f));
  }, []);

  const filterMyFiles = useCallback(f => f.sender === user.name, [user.name]);
  const filterPending = useCallback(f => user.role === 'Approver' && f.isApproverAction && (f.status === 'Pending' || f.status === 'Returned'), [user.role]);

  return (
    <div className="min-h-screen bg-slate-50/50 font-sans selection:bg-indigo-100 selection:text-indigo-700">
      <script src="https://cdn.tailwindcss.com"></script>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Serif font for official documents */
        .font-serif { font-family: 'Playfair Display', serif; } 
        .font-cursive { font-family: 'Dancing Script', cursive; }
        
        /* Subtle paper texture effect for document preview */
        .document-paper-texture {
            background-image: linear-gradient(to bottom, rgba(240, 240, 240, 0.5) 1px, transparent 1px);
            background-size: 100% 1.5rem;
        }

        /* Smooth Scroll & Animations */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
      
      <TopNavBar 
        user={user} 
        activeModule={activeModule} 
        setActiveModule={setActiveModule} 
        notifications={notifications}
        onNotificationAction={(n) => {
           const f = files.find(x => x.id === n.fileId);
           if(f) handleOpenFile(f);
        }}
      />

      <main className="max-w-7xl mx-auto py-8 px-6">
        {activeModule === 'Dashboard' && <Dashboard user={user} files={files} onOpenFile={handleOpenFile} setActiveModule={setActiveModule} />}
        {activeModule === 'My Nothis' && <FileListTable user={user} files={files} title="My Nothis" filterFn={filterMyFiles} onOpenFile={handleOpenFile} />} {/* Terminology Change */}
        {activeModule === 'Pending Approvals' && <FileListTable user={user} files={files} title="Pending Approvals" filterFn={filterPending} onOpenFile={handleOpenFile} />}
        {activeModule === 'Create Nothi' && <CreateFile user={user} onCreateSuccess={handleCreateSuccess} />} {/* Terminology Change */}
      </main>

      {/* The Context Drawer - Key UX Improvement */}
      <SlideOver isOpen={!!viewingFile} onClose={() => setViewingFile(null)} title="Nothi Inspector"> {/* Terminology Change */}
        {viewingFile && <FileInspector file={viewingFile} user={user} onClose={() => setViewingFile(null)} onUpdate={handleUpdateFile} />}
      </SlideOver>
    </div>
  );
};

export default App;